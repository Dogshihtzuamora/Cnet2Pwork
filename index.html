<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat P2P</title>

<style>
:root {
--background-color:#121212;
--text-color:#e0e0e0;
--primary-color:#ff9800;
--secondary-color:#333;
--input-bg:#333;
--button-bg:#ff9800;
--button-hover-bg:#fb8c00;
--status-dot-online:#4CAF50;
--status-dot-offline:#ccc;
--message-self-bg:#1c1c1c;
--message-other-bg:#333;
--header-bg:#1a1a1a;
--border-color:#444;
}

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:sans-serif;
}

body{
background:var(--background-color);
color:var(--text-color);
display:flex;
justify-content:center;
align-items:center;
height:100vh;
}

.container{
width:100%;
max-width:450px;
height:90vh;
display:flex;
flex-direction:column;
background:var(--secondary-color);
border-radius:12px;
overflow:hidden;
}

.header{
padding:16px;
background:var(--header-bg);
display:flex;
justify-content:space-between;
align-items:center;
border-bottom:2px solid var(--border-color);
}

.username-area{
display:flex;
gap:8px;
}

.status-area{
display:flex;
align-items:center;
gap:8px;
font-size:14px;
}

.status-dot{
width:12px;
height:12px;
border-radius:50%;
background:var(--status-dot-offline);
}

.status-dot.online{
background:var(--status-dot-online);
}

.messages-container{
flex:1;
overflow-y:auto;
padding:16px;
display:flex;
flex-direction:column;
gap:8px;
}

.message{
max-width:85%;
padding:10px 14px;
border-radius:14px;
font-size:14px;
word-break:break-word;
}

.message.self{
align-self:flex-end;
background:var(--message-self-bg);
}

.message.other{
align-self:flex-start;
background:var(--message-other-bg);
}

.reply-preview{
font-size:12px;
opacity:.7;
border-left:3px solid var(--primary-color);
padding-left:6px;
margin-bottom:4px;
}

.reply-bar{
background:#1a1a1a;
padding:8px;
font-size:13px;
border-top:2px solid var(--primary-color);
display:flex;
justify-content:space-between;
align-items:center;
}

.input-area{
display:flex;
gap:8px;
padding:12px;
border-top:2px solid var(--border-color);
}

#message-input{
flex:1;
padding:12px;
border-radius:30px;
border:none;
background:var(--input-bg);
color:var(--text-color);
}

#send-button{
padding:12px 20px;
border:none;
border-radius:30px;
background:var(--button-bg);
cursor:pointer;
}

#username-input{
padding:8px;
border-radius:8px;
border:none;
background:var(--input-bg);
color:var(--text-color);
}

#set-username{
padding:8px 12px;
border:none;
border-radius:8px;
background:var(--primary-color);
cursor:pointer;
}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <div class="username-area">
    <input id="username-input" placeholder="Seu nome">
    <button id="set-username">Definir</button>
  </div>
  <div class="status-area">
    <div class="status-dot" id="status"></div>
    <span id="status-text">Desconectado</span>
  </div>
</div>

<div id="messages" class="messages-container"></div>

<div id="reply-holder"></div>

<div class="input-area">
  <input id="message-input" placeholder="Digite sua mensagem">
  <button id="send-button">Enviar</button>
</div>

</div>

<script>
const state = {
  username: localStorage.getItem('username') || 'Anônimo'
}

const messages = document.getElementById('messages')
const input = document.getElementById('message-input')
const send = document.getElementById('send-button')
const userInput = document.getElementById('username-input')
const setUser = document.getElementById('set-username')
const statusDot = document.getElementById('status')
const statusText = document.getElementById('status-text')
const replyHolder = document.getElementById('reply-holder')

userInput.value = state.username

let socket
let replyTo = null
let startX = 0

function connect(){
  socket = new WebSocket(
    (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host
  )

  socket.onopen = () => {
    statusDot.classList.add('online')
    statusText.textContent = 'Conectado'
  }

  socket.onclose = () => {
    statusDot.classList.remove('online')
    statusText.textContent = 'Desconectado'
    setTimeout(connect,2000)
  }

  socket.onmessage = e => {
    let msg
    try{ msg = JSON.parse(e.data) }catch{return}
    if(msg.type === 'chat' && msg.username !== state.username){
      render(msg.username,msg.message,msg.replyTo,false)
    }
  }
}

connect()

setUser.onclick = () => {
  const v = userInput.value.trim()
  if(!v) return
  state.username = v
  localStorage.setItem('username',v)
}

function render(user,text,reply,self){
  const div = document.createElement('div')
  div.className = 'message ' + (self?'self':'other')

  if(reply){
    const r = document.createElement('div')
    r.className = 'reply-preview'
    r.textContent = reply
    div.appendChild(r)
  }

  const b = document.createElement('div')
  b.textContent = user + ': ' + text
  div.appendChild(b)

  if(!self){
    div.addEventListener('touchstart',e=>{
      startX = e.touches[0].clientX
    })
    div.addEventListener('touchmove',e=>{
      if(e.touches[0].clientX - startX > 60){
        setReply(text)
        startX = 9999
      }
    })
  }

  messages.appendChild(div)
  messages.scrollTop = messages.scrollHeight
}

function setReply(text){
  replyTo = text
  replyHolder.innerHTML = ''

  const bar = document.createElement('div')
  bar.className = 'reply-bar'
  bar.textContent = 'Respondendo: ' + text

  const x = document.createElement('span')
  x.textContent = '✕'
  x.style.cursor = 'pointer'
  x.onclick = ()=>{
    replyTo = null
    replyHolder.innerHTML = ''
  }

  bar.appendChild(x)
  replyHolder.appendChild(bar)
}

send.onclick = ()=>{
  const msg = input.value.trim()
  if(!msg || socket.readyState!==1) return

  socket.send(JSON.stringify({
    type:'chat',
    username:state.username,
    message:msg,
    replyTo
  }))

  render(state.username,msg,replyTo,true)
  replyTo=null
  replyHolder.innerHTML=''
  input.value=''
}

input.onkeypress = e => e.key==='Enter' && send.onclick()
</script>

</body>
</html>
