<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat P2P</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0a0a0a;
    color: #e0e0e0;
    height: 100vh;
    overflow: hidden;
}

.container {
    display: flex;
    height: 100vh;
}

.sidebar {
    width: 350px;
    background: #1a1a1a;
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 20px;
    background: #111;
    border-bottom: 1px solid #333;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.avatar-upload {
    position: relative;
    cursor: pointer;
}

.avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    border: 2px solid #00ff88;
}

.avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.username-input {
    flex: 1;
    background: #242424;
    border: 1px solid #333;
    padding: 10px;
    border-radius: 8px;
    color: #e0e0e0;
    outline: none;
}

.rooms-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
}

.rooms-header h3 {
    font-size: 14px;
    color: #888;
}

.new-room-btn {
    background: #00ff88;
    color: #000;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
}

.rooms-list {
    flex: 1;
    overflow-y: auto;
}

.room-item {
    padding: 15px 20px;
    border-bottom: 1px solid #222;
    cursor: pointer;
    transition: background 0.2s;
}

.room-item:hover {
    background: #242424;
}

.room-item.active {
    background: #1e3a2f;
    border-left: 3px solid #00ff88;
}

.room-name {
    font-weight: 600;
    margin-bottom: 5px;
}

.room-info {
    font-size: 12px;
    color: #888;
}

.chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #0a0a0a;
}

.chat-header {
    padding: 20px;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.room-title {
    font-size: 18px;
    font-weight: 600;
}

.status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #888;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #666;
}

.status-dot.online {
    background: #00ff88;
    box-shadow: 0 0 10px #00ff88;
}

.messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.message {
    display: flex;
    gap: 10px;
    max-width: 70%;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
}

.message.self {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.message-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.message-content {
    flex: 1;
}

.message-header {
    font-size: 12px;
    color: #888;
    margin-bottom: 4px;
    display: flex;
    gap: 8px;
}

.message-bubble {
    background: #2a2a2a;
    padding: 10px 14px;
    border-radius: 12px;
    word-wrap: break-word;
    position: relative;
}

.message.self .message-bubble {
    background: #1e3a2f;
}

.reply-indicator {
    background: #1a1a1a;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 6px;
    border-left: 3px solid #00ff88;
    font-size: 12px;
    color: #888;
}

.system-msg {
    text-align: center;
    color: #666;
    font-size: 12px;
    padding: 8px;
}

.input-area {
    background: #1a1a1a;
    border-top: 1px solid #333;
    padding: 15px 20px;
}

.reply-preview {
    background: #242424;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: none;
    align-items: center;
    justify-content: space-between;
}

.reply-preview.active {
    display: flex;
}

.reply-text {
    font-size: 13px;
    color: #888;
}

.cancel-reply {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 18px;
}

.input-wrapper {
    display: flex;
    gap: 10px;
}

.message-input {
    flex: 1;
    background: #242424;
    border: 1px solid #333;
    padding: 12px 16px;
    border-radius: 24px;
    color: #e0e0e0;
    outline: none;
    font-size: 14px;
}

.send-btn {
    background: #00ff88;
    color: #000;
    border: none;
    padding: 12px 24px;
    border-radius: 24px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
}

.send-btn:active {
    transform: scale(0.95);
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: #1a1a1a;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
}

.modal-content h2 {
    margin-bottom: 20px;
}

.modal-input {
    width: 100%;
    background: #242424;
    border: 1px solid #333;
    padding: 12px;
    border-radius: 8px;
    color: #e0e0e0;
    margin-bottom: 15px;
    outline: none;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.modal-btn.primary {
    background: #00ff88;
    color: #000;
}

.modal-btn.secondary {
    background: #333;
    color: #e0e0e0;
}

@media (max-width: 768px) {
    .sidebar {
        width: 100%;
        position: absolute;
        z-index: 10;
        transform: translateX(-100%);
        transition: transform 0.3s;
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .message {
        max-width: 85%;
    }
}

.messages::-webkit-scrollbar,
.rooms-list::-webkit-scrollbar {
    width: 6px;
}

.messages::-webkit-scrollbar-track,
.rooms-list::-webkit-scrollbar-track {
    background: #1a1a1a;
}

.messages::-webkit-scrollbar-thumb,
.rooms-list::-webkit-scrollbar-thumb {
    background: #333;
    border-radius: 3px;
}

.context-menu {
    position: absolute;
    background: #242424;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 5px 0;
    display: none;
    z-index: 1000;
}

.context-menu.active {
    display: block;
}

.context-item {
    padding: 10px 20px;
    cursor: pointer;
    font-size: 14px;
}

.context-item:hover {
    background: #333;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="avatar-upload" onclick="document.getElementById('avatar-input').click()">
                        <div class="avatar" id="user-avatar">ðŸ‘¤</div>
                    </div>
                    <input type="file" id="avatar-input" accept="image/*" style="display:none">
                    <input type="text" class="username-input" id="username" placeholder="Seu nome" value="">
                </div>
                <div class="rooms-header">
                    <h3>SALAS</h3>
                    <button class="new-room-btn" onclick="openNewRoomModal()">+ Nova Sala</button>
                </div>
            </div>
            <div class="rooms-list" id="rooms-list"></div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div>
                    <div class="room-title" id="current-room-name">Selecione uma sala</div>
                </div>
                <div class="status">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">Desconectado</span>
                </div>
            </div>

            <div class="messages" id="messages"></div>

            <div class="input-area">
                <div class="reply-preview" id="reply-preview">
                    <div class="reply-text" id="reply-text"></div>
                    <button class="cancel-reply" onclick="cancelReply()">âœ•</button>
                </div>
                <div class="input-wrapper">
                    <input type="text" class="message-input" id="message-input" placeholder="Digite uma mensagem...">
                    <button class="send-btn" onclick="sendMessage()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="new-room-modal">
        <div class="modal-content">
            <h2>Nova Sala</h2>
            <input type="text" class="modal-input" id="room-name-input" placeholder="Nome da sala">
            <input type="password" class="modal-input" id="room-password-input" placeholder="Senha (opcional)">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeNewRoomModal()">Cancelar</button>
                <button class="modal-btn primary" onclick="createRoom()">Criar</button>
            </div>
        </div>
    </div>

    <div class="context-menu" id="context-menu">
        <div class="context-item" onclick="replyToMessage()">Responder</div>
    </div>

    <script>
const state = {
    userId: localStorage.getItem('userId') || crypto.randomUUID(),
    username: localStorage.getItem('username') || 'AnÃ´nimo',
    avatar: localStorage.getItem('avatar') || null,
    currentRoom: 'global',
    rooms: JSON.parse(localStorage.getItem('rooms') || '{"global":{"name":"Global","password":null,"messages":[]}}'),
    replyTo: null,
    ws: null,
    connected: false
}

localStorage.setItem('userId', state.userId)

document.getElementById('username').value = state.username

function compressImage(file, maxSizeMB = 2) {
    return new Promise((resolve) => {
        const reader = new FileReader()
        reader.onload = (e) => {
            const img = new Image()
            img.onload = () => {
                const canvas = document.createElement('canvas')
                let width = img.width
                let height = img.height
                const maxDim = 800
                
                if (width > height && width > maxDim) {
                    height = (height * maxDim) / width
                    width = maxDim
                } else if (height > maxDim) {
                    width = (width * maxDim) / height
                    height = maxDim
                }
                
                canvas.width = width
                canvas.height = height
                const ctx = canvas.getContext('2d')
                ctx.drawImage(img, 0, 0, width, height)
                
                let quality = 0.8
                let result = canvas.toDataURL('image/jpeg', quality)
                
                while (result.length > maxSizeMB * 1024 * 1024 && quality > 0.1) {
                    quality -= 0.1
                    result = canvas.toDataURL('image/jpeg', quality)
                }
                
                resolve(result)
            }
            img.src = e.target.result
        }
        reader.readAsDataURL(file)
    })
}

document.getElementById('avatar-input').addEventListener('change', async (e) => {
    const file = e.target.files[0]
    if (!file) return
    
    const compressed = await compressImage(file, 2)
    state.avatar = compressed
    localStorage.setItem('avatar', compressed)
    document.getElementById('user-avatar').innerHTML = `<img src="${compressed}">`
})

document.getElementById('username').addEventListener('change', (e) => {
    state.username = e.target.value.trim() || 'AnÃ´nimo'
    localStorage.setItem('username', state.username)
})

function connectWS() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:'
    state.ws = new WebSocket(`${protocol}//${location.host}`)
    
    state.ws.onopen = () => {
        state.connected = true
        updateStatus('Conectado', true)
        sendToServer({ type: 'join', room: state.currentRoom, userId: state.userId })
        syncMessages()
    }
    
    state.ws.onclose = () => {
        state.connected = false
        updateStatus('Desconectado', false)
        setTimeout(connectWS, 3000)
    }
    
    state.ws.onmessage = (e) => {
        const data = JSON.parse(e.data)
        handleMessage(data)
    }
}

function handleMessage(data) {
    switch(data.type) {
        case 'init':
            updateStatus(`Conectado (${data.peers} peers)`, true)
            break
        case 'peer':
            updateStatus(`Conectado (${data.total} peers)`, true)
            break
        case 'chat':
            if (data.room === state.currentRoom) {
                addMessage(data)
            }
            saveMessage(data)
            break
        case 'sync':
            if (data.messages) {
                data.messages.forEach(msg => saveMessage(msg))
                renderMessages()
            }
            break
    }
}

function saveMessage(msg) {
    if (!state.rooms[msg.room]) {
        state.rooms[msg.room] = { name: msg.room, password: null, messages: [] }
    }
    if (!state.rooms[msg.room].messages.find(m => m.id === msg.id)) {
        state.rooms[msg.room].messages.push(msg)
        localStorage.setItem('rooms', JSON.stringify(state.rooms))
    }
}

function syncMessages() {
    const roomMsgs = state.rooms[state.currentRoom]?.messages || []
    sendToServer({ type: 'sync', room: state.currentRoom, messages: roomMsgs })
}

function updateStatus(text, online) {
    document.getElementById('status-text').textContent = text
    document.getElementById('status-dot').classList.toggle('online', online)
}

function addMessage(msg) {
    const div = document.createElement('div')
    div.className = `message ${msg.userId === state.userId ? 'self' : ''}`
    div.dataset.id = msg.id
    div.oncontextmenu = (e) => showContextMenu(e, msg)
    
    const time = new Date(msg.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    
    let replyHtml = ''
    if (msg.replyTo) {
        const original = state.rooms[state.currentRoom]?.messages.find(m => m.id === msg.replyTo)
        if (original) {
            replyHtml = `<div class="reply-indicator">${original.username}: ${original.message.substring(0, 50)}...</div>`
        }
    }
    
    div.innerHTML = `
        <div class="message-avatar">
            ${msg.avatar ? `<img src="${msg.avatar}">` : 'ðŸ‘¤'}
        </div>
        <div class="message-content">
            <div class="message-header">
                <strong>${msg.username}</strong>
                <span>${time}</span>
            </div>
            <div class="message-bubble">
                ${replyHtml}
                ${escapeHtml(msg.message)}
            </div>
        </div>
    `
    
    document.getElementById('messages').appendChild(div)
    scrollToBottom()
}

function escapeHtml(text) {
    const div = document.createElement('div')
    div.textContent = text
    return div.innerHTML
}

function scrollToBottom() {
    const msgs = document.getElementById('messages')
    msgs.scrollTop = msgs.scrollHeight
}

function sendMessage() {
    const input = document.getElementById('message-input')
    const msg = input.value.trim()
    if (!msg || !state.connected) return
    
    const message = {
        type: 'chat',
        id: crypto.randomUUID(),
        room: state.currentRoom,
        userId: state.userId,
        username: state.username,
        avatar: state.avatar,
        message: msg,
        timestamp: Date.now(),
        replyTo: state.replyTo
    }
    
    sendToServer(message)
    addMessage(message)
    saveMessage(message)
    
    input.value = ''
    cancelReply()
}

function sendToServer(data) {
    if (state.ws && state.ws.readyState === WebSocket.OPEN) {
        state.ws.send(JSON.stringify(data))
    }
}

document.getElementById('message-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage()
})

function showContextMenu(e, msg) {
    e.preventDefault()
    const menu = document.getElementById('context-menu')
    menu.style.left = e.pageX + 'px'
    menu.style.top = e.pageY + 'px'
    menu.classList.add('active')
    menu.dataset.msgId = msg.id
}

document.addEventListener('click', () => {
    document.getElementById('context-menu').classList.remove('active')
})

function replyToMessage() {
    const msgId = document.getElementById('context-menu').dataset.msgId
    const msg = state.rooms[state.currentRoom]?.messages.find(m => m.id === msgId)
    if (!msg) return
    
    state.replyTo = msgId
    document.getElementById('reply-text').textContent = `${msg.username}: ${msg.message.substring(0, 50)}...`
    document.getElementById('reply-preview').classList.add('active')
    document.getElementById('message-input').focus()
}

function cancelReply() {
    state.replyTo = null
    document.getElementById('reply-preview').classList.remove('active')
}

function openNewRoomModal() {
    document.getElementById('new-room-modal').classList.add('active')
}

function closeNewRoomModal() {
    document.getElementById('new-room-modal').classList.remove('active')
}

function createRoom() {
    const name = document.getElementById('room-name-input').value.trim()
    const password = document.getElementById('room-password-input').value
    
    if (!name) return
    
    const roomId = name.toLowerCase().replace(/\s+/g, '-')
    state.rooms[roomId] = { name, password, messages: [] }
    localStorage.setItem('rooms', JSON.stringify(state.rooms))
    
    closeNewRoomModal()
    renderRooms()
    switchRoom(roomId)
}

function renderRooms() {
    const list = document.getElementById('rooms-list')
    list.innerHTML = ''
    
    Object.entries(state.rooms).forEach(([id, room]) => {
        const div = document.createElement('div')
        div.className = `room-item ${id === state.currentRoom ? 'active' : ''}`
        div.onclick = () => switchRoom(id)
        div.innerHTML = `
            <div class="room-name">${room.name}</div>
            <div class="room-info">${room.messages.length} mensagens</div>
        `
        list.appendChild(div)
    })
}

function switchRoom(roomId) {
    state.currentRoom = roomId
    document.getElementById('current-room-name').textContent = state.rooms[roomId].name
    renderRooms()
    renderMessages()
    if (state.connected) {
        sendToServer({ type: 'join', room: roomId, userId: state.userId })
        syncMessages()
    }
}

function renderMessages() {
    document.getElementById('messages').innerHTML = ''
    const msgs = state.rooms[state.currentRoom]?.messages || []
    msgs.forEach(msg => addMessage(msg))
}

if (state.avatar) {
    document.getElementById('user-avatar').innerHTML = `<img src="${state.avatar}">`
}

renderRooms()
switchRoom('global')
connectWS()
    </script>
</body>
</html>
