<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chat P2P</title>
<style>
body{margin:0;background:#121212;color:#e0e0e0;font-family:sans-serif;display:flex;justify-content:center;height:100vh}
.container{width:100%;max-width:450px;display:flex;flex-direction:column}
.header{display:flex;gap:6px;padding:10px;background:#1a1a1a}
.messages{flex:1;overflow:auto;padding:10px}
.message{margin:6px 0;padding:8px;border-radius:10px;max-width:85%}
.self{background:#1c1c1c;margin-left:auto}
.other{background:#333}
.reply{font-size:11px;opacity:.7;border-left:2px solid #ff9800;padding-left:6px;margin-bottom:4px}
.input{display:flex;padding:10px;gap:6px}
input,button{padding:10px;border-radius:6px;border:none}
button{background:#ff9800;color:#000;cursor:pointer}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <input id="username">
    <button id="save">OK</button>
  </div>

  <div class="messages" id="messages"></div>

  <div class="input">
    <input id="text" placeholder="Mensagem">
    <button id="send">Enviar</button>
  </div>
</div>

<script>
const messages = document.getElementById('messages')
const text = document.getElementById('text')
const send = document.getElementById('send')
const usernameInput = document.getElementById('username')

let username = localStorage.getItem('username') || 'Anônimo'
let replyTo = null
let socket
let reconnecting = false

usernameInput.value = username

document.getElementById('save').onclick = () => {
  username = usernameInput.value.trim() || 'Anônimo'
  localStorage.setItem('username', username)
}

function connect() {
  socket = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host)

  socket.onopen = () => reconnecting = false

  socket.onclose = () => {
    if (!reconnecting) {
      reconnecting = true
      setTimeout(connect, 2000)
    }
  }

  socket.onmessage = e => {
    let data
    try { data = JSON.parse(e.data) } catch { return }
    if (data.type === 'chat') render(data.username, data.message, data.replyTo, false)
  }
}

connect()

function render(user, msg, reply, self) {
  const div = document.createElement('div')
  div.className = 'message ' + (self ? 'self' : 'other')

  if (reply) {
    const r = document.createElement('div')
    r.className = 'reply'
    r.textContent = reply
    div.appendChild(r)
  }

  const body = document.createElement('div')
  body.textContent = user + ': ' + msg
  div.appendChild(body)

  div.onclick = () => replyTo = msg
  messages.appendChild(div)
  messages.scrollTop = messages.scrollHeight
}

send.onclick = () => {
  const msg = text.value.trim()
  if (!msg || socket.readyState !== 1) return

  socket.send(JSON.stringify({
    type: 'chat',
    username,
    message: msg,
    replyTo
  }))

  render(username, msg, replyTo, true)
  replyTo = null
  text.value = ''
}

text.onkeypress = e => e.key === 'Enter' && send.onclick()
</script>
</body>
</html>
