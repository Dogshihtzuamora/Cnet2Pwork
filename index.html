<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>P2P WhatsApp</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, sans-serif;
  background: #0b141a;
  color: #e9edef;
  height: 100vh;
  overflow: hidden;
  position: fixed;
  width: 100%;
}

#login {
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 15px;
  padding: 20px;
}

#login h2 {
  color: #00a884;
  margin-bottom: 10px;
}

#login input, #login button {
  width: 100%;
  max-width: 300px;
  padding: 14px 16px;
  border-radius: 8px;
  border: 1px solid #2a3942;
  background: #2a3942;
  color: #e9edef;
  font-size: 16px;
}

#login button {
  background: #00a884;
  border: none;
  cursor: pointer;
  font-weight: 600;
}

#avatar-preview {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  display: none;
  border: 3px solid #00a884;
}

#error {
  color: #ff4444;
  font-size: 14px;
}

#app {
  display: none;
  height: 100vh;
  height: 100dvh;
  flex-direction: column;
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
}

.header {
  background: #202c33;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #2a3942;
  flex-wrap: wrap;
  min-height: 60px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  min-width: 120px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.user-details {
  overflow: hidden;
}

.user-name {
  font-weight: 600;
  font-size: 15px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.current-room {
  font-size: 12px;
  color: #8696a0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.room-selector {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
}

#room-input {
  padding: 8px 12px;
  border-radius: 20px;
  border: 1px solid #2a3942;
  background: #2a3942;
  color: #e9edef;
  font-size: 13px;
  width: 100px;
}

#join-room, #global-btn {
  padding: 8px 14px;
  border-radius: 20px;
  border: none;
  background: #00a884;
  color: #e9edef;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}

#global-btn {
  background: #667781;
}

#messages {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 12px;
  background: #0b141a;
  display: flex;
  flex-direction: column;
  gap: 6px;
  -webkit-overflow-scrolling: touch;
}

#messages::-webkit-scrollbar {
  width: 4px;
}

#messages::-webkit-scrollbar-thumb {
  background: #2a3942;
  border-radius: 2px;
}

.msg {
  display: flex;
  gap: 6px;
  max-width: 75%;
  animation: fadeIn 0.2s;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.self {
  margin-left: auto;
  flex-direction: row-reverse;
}

.msg-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.msg-content {
  background: #202c33;
  padding: 6px 10px;
  border-radius: 8px;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.msg.self .msg-content {
  background: #005c4b;
}

.msg-name {
  font-weight: 600;
  font-size: 13px;
  color: #00a884;
  margin-bottom: 2px;
}

.msg.self .msg-name {
  display: none;
}

.msg-text {
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.msg-time {
  font-size: 11px;
  color: #8696a0;
  margin-top: 2px;
  text-align: right;
}

.input-area {
  background: #202c33;
  padding: 8px 12px;
  display: flex;
  gap: 8px;
  align-items: center;
  border-top: 1px solid #2a3942;
  padding-bottom: max(8px, env(safe-area-inset-bottom));
}

#text {
  flex: 1;
  padding: 12px 16px;
  border-radius: 24px;
  border: none;
  background: #2a3942;
  color: #e9edef;
  font-size: 15px;
  outline: none;
}

#text::placeholder {
  color: #8696a0;
}

#send {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  background: #00a884;
  color: #fff;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

@media (max-width: 480px) {
  .header {
    padding: 8px 10px;
  }
  
  .user-name {
    font-size: 14px;
  }
  
  #room-input {
    width: 80px;
    font-size: 12px;
  }
  
  #join-room, #global-btn {
    padding: 7px 12px;
    font-size: 11px;
  }
  
  .msg {
    max-width: 85%;
  }
  
  .msg-text {
    font-size: 13px;
  }
}
</style>
</head>
<body>

<div id="login">
  <h2>ðŸš€ P2P WhatsApp</h2>
  <img id="avatar-preview" alt="Preview">
  <input id="name" placeholder="Seu nome" maxlength="25">
  <input id="avatar" type="file" accept="image/*">
  <button id="create">Entrar no Chat</button>
  <div id="error"></div>
</div>

<div id="app">
  <div class="header">
    <div class="user-info">
      <img class="user-avatar" id="current-avatar" alt="Avatar">
      <div class="user-details">
        <div class="user-name" id="current-name"></div>
        <div class="current-room" id="current-room">Sala: Global</div>
      </div>
    </div>
    <div class="room-selector">
      <input id="room-input" placeholder="Sala">
      <button id="join-room">Entrar</button>
      <button id="global-btn">Global</button>
    </div>
  </div>
  
  <div id="messages"></div>
  
  <div class="input-area">
    <input id="text" placeholder="Mensagem" autocomplete="off">
    <button id="send">âž¤</button>
  </div>
</div>

<script>
const login = document.getElementById('login')
const app = document.getElementById('app')
const messages = document.getElementById('messages')
const text = document.getElementById('text')
const avatarInput = document.getElementById('avatar')
const avatarPreview = document.getElementById('avatar-preview')

const state = {
  userId: localStorage.getItem('uid') || crypto.randomUUID(),
  name: localStorage.getItem('name'),
  avatar: localStorage.getItem('avatar'),
  currentRoom: 'global'
}

localStorage.setItem('uid', state.userId)

if (state.name && state.avatar) {
  login.style.display = 'none'
  app.style.display = 'flex'
  document.getElementById('current-name').textContent = state.name
  document.getElementById('current-avatar').src = state.avatar
  initChat()
} else {
  login.style.display = 'flex'
}

avatarInput.onchange = () => {
  const file = avatarInput.files[0]
  if (!file) return
  
  const reader = new FileReader()
  reader.onload = () => {
    avatarPreview.src = reader.result
    avatarPreview.style.display = 'block'
  }
  reader.readAsDataURL(file)
}

document.getElementById('create').onclick = () => {
  const name = document.getElementById('name').value.trim()
  const file = avatarInput.files[0]

  if (!name) {
    document.getElementById('error').textContent = 'Digite seu nome'
    return
  }

  if (!file) {
    document.getElementById('error').textContent = 'Selecione uma foto'
    return
  }

  const reader = new FileReader()
  reader.onload = () => {
    const img = new Image()
    img.onload = () => {
      const canvas = document.createElement('canvas')
      const size = 200
      canvas.width = size
      canvas.height = size
      
      const ctx = canvas.getContext('2d')
      const aspect = img.width / img.height
      let sx = 0, sy = 0, sw = img.width, sh = img.height
      
      if (aspect > 1) {
        sw = img.height
        sx = (img.width - img.height) / 2
      } else {
        sh = img.width
        sy = (img.height - img.width) / 2
      }
      
      ctx.drawImage(img, sx, sy, sw, sh, 0, 0, size, size)
      
      const compressed = canvas.toDataURL('image/jpeg', 0.7)
      
      state.name = name
      state.avatar = compressed

      localStorage.setItem('name', name)
      localStorage.setItem('avatar', compressed)

      document.getElementById('current-name').textContent = name
      document.getElementById('current-avatar').src = compressed

      login.style.display = 'none'
      app.style.display = 'flex'
      
      initChat()
    }
    img.src = reader.result
  }
  reader.readAsDataURL(file)
}

let ws

function initChat() {
  ws = new WebSocket(
    (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host
  )

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type: 'join-room',
      roomId: state.currentRoom,
      userId: state.userId
    }))
  }

  ws.onmessage = e => {
    const data = JSON.parse(e.data)

    if (data.type === 'room-joined') {
      document.getElementById('current-room').textContent = `Sala: ${data.roomId} (${data.connections} peers)`
    }

    if (data.type === 'peer') {
      if (data.action === 'connected') {
        console.log(`Peer conectado: ${data.id}`)
      } else {
        console.log(`Peer desconectado: ${data.id}`)
      }
      document.getElementById('current-room').textContent = `Sala: ${state.currentRoom} (${data.total} peers)`
    }

    if (data.type === 'chat') {
      render(data)
    }
  }

  ws.onclose = () => {
    setTimeout(initChat, 3000)
  }
}

document.getElementById('send').onclick = send
text.onkeypress = e => {
  if (e.key === 'Enter') send()
}

function send() {
  if (!text.value.trim()) return

  ws.send(JSON.stringify({
    type: 'chat',
    msgId: crypto.randomUUID(),
    userId: state.userId,
    name: state.name,
    avatar: state.avatar,
    message: text.value
  }))

  text.value = ''
}

function render(m) {
  const div = document.createElement('div')
  div.className = 'msg ' + (m.userId === state.userId ? 'self' : 'other')

  const time = new Date(m.time).toLocaleTimeString('pt-BR', { 
    hour: '2-digit', 
    minute: '2-digit' 
  })

  div.innerHTML = `
    <img class="msg-avatar" src="${m.avatar}" alt="${m.name}">
    <div class="msg-content">
      <div class="msg-name">${m.name}</div>
      <div class="msg-text">${m.message}</div>
      <div class="msg-time">${time}</div>
    </div>
  `
  
  messages.appendChild(div)
  messages.scrollTop = messages.scrollHeight
}

document.getElementById('join-room').onclick = () => {
  const roomId = document.getElementById('room-input').value.trim()
  if (!roomId) return
  
  state.currentRoom = roomId
  messages.innerHTML = ''
  
  ws.send(JSON.stringify({
    type: 'join-room',
    roomId: roomId,
    userId: state.userId
  }))
}

document.getElementById('global-btn').onclick = () => {
  state.currentRoom = 'global'
  messages.innerHTML = ''
  
  ws.send(JSON.stringify({
    type: 'join-room',
    roomId: 'global',
    userId: state.userId
  }))
}
</script>
</body>
</html>
